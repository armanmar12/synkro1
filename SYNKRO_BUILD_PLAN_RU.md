# Synkro.kz: пошаговый план разработки (Python-first)

Этот файл - единый "путеводитель" по созданию веб-сервиса Synkro.kz: роли, страницы, интеграции, фоновые задачи, безопасность, деплой.

Цели: стабильность, безопасность, предсказуемость, корпоративная пригодность. Дизайн (неоморфизм) вторичен к безопасности, но учитывается.

## 0) Ключевые решения (фиксируем)

### 0.1 URL-структура (рекомендация для MVP)
- Публичная главная: `https://synkro.kz/` (пока не трогаем, можно оставить статикой/пустой).
- Вход: `https://synkro.kz/login`
- Кабинет: `https://synkro.kz/dashboard`
- Админка (только для персонала): `https://synkro.kz/admin`

Почему не `dashboard.synkro.kz` в MVP:
- меньше DNS/сертификатов/прокси-настроек;
- проще поддерживать;
- на будущее можно вынести в поддомен без изменения логики.

### 0.2 Стек (MVP)
- Backend + UI: `Django` (Python) + Django templates
- API (внутренний/внешний): `Django REST Framework` (DRF)
- Очереди и фоновые задачи: `Celery` + `Redis`
- Центральная БД сервиса: `Postgres`
- Интеграции: `httpx` (или `requests`)
- UI интерактивность: `HTMX` (минимум JS) + чистый CSS (неоморфизм)

Опционально позже (если UI станет сильно сложным):
- `Next.js` как отдельный фронт, Django оставить как API.

### 0.3 Принцип безопасности
Секреты интеграций (amoCRM, Radist, AI key, Supabase `service_role`) НИКОГДА не уходят в браузер.
Все интеграции вызываются только с сервера, секреты хранятся шифрованно в центральной БД.

### 0.4 Мульти-tenant модель (изолируем клиентов)
- У каждого клиента свой Supabase-проект (как ты и хочешь).
- В нашей центральной БД хранится конфиг подключения к Supabase клиента (URL + ключи), но:
  - `anon key` можно хранить как есть;
  - `service_role key` хранить только шифрованно;
  - UI видит только статусы (валидно/невалидно), но не сами ключи после сохранения.

## 1) Роли и доступ (RBAC)

### 1.1 Роли
- `super_admin`: управляет пользователями/ролями/тенантами, может удалять.
- `admin_lite`: может создавать/включать/выключать пользователей, удалять не может.
- `user`: видит `Обзор` и `Отчеты`. Настройки по умолчанию закрыты.

### 1.2 Важное уточнение из требований
Админы не "владельцы" компаний и не смотрят магазины/отчеты клиентов. Их зона - управление доступом.
Это значит: админ-пользователи "глобальные" (не привязаны к tenant).

## 2) Страницы кабинета (MVP)

### 2.1 Навигация
- `Dashboard / Обзор` (стартовая после входа): пока можно минимально (плитки статусов, последние отчеты).
- `Dashboard / Отчеты`: список отчётов, просмотр, комментарии.
- `Dashboard / Настройки`: мастер настройки интеграций и автоматизации (только для роли, которую разрешим).

### 2.2 Неоморфизм (дизайн-направление)
Неоморфизм делается CSS-ом, без Next.js. Технически несложно, но есть риск по доступности (контраст).
Правило: если красивый стиль конфликтует с читаемостью/контрастом, выбираем читаемость.

Мини-набор UI компонентов (чтобы не утонуть):
- Card (плитка), Input, Button, Toggle, Tabs, Table, Badge, Progress/Step indicators, Toast.

## 3) Данные и сущности (черновая модель)

### 3.1 Центральная БД сервиса (наша)
- `Tenant`: клиент/компания (id, name, slug, status).
- `User`: пользователи (роль, активность, привязка к tenant или глобальный админ без tenant).
- `IntegrationConfig`: настройки интеграций для tenant (тип, шифрованные поля, статус проверки).
- `JobRun`: запуск пайплайна/задачи (tenant, тип, статус, текущий шаг, прогресс, ошибки, timestamps).
- `Report`: отчёт (tenant, период, тип, статус, итоговый текст, метаданные, ссылки на данные в Supabase).
- `ReportMessage`: follow-up Q/A (ограничение 2 вопроса, история сообщений, кто задал).
- `AuditLog`: кто что сделал (создание пользователя, смена ключей, запуск отчёта, ошибки).

### 3.2 Клиентский Supabase (у каждого клиента свой)
Мы создаем таблицы для:
- сырых диалогов (amoCRM)
- сырых звонков/транскриптов (Radist)
- результатов анализа AI
- саммари для списка отчётов

Важно: schema/таблицы в Supabase должны быть одинаковыми у всех клиентов, чтобы код был единый.

## 4) Интеграции и мастер настройки (Settings Wizard)

Каждый шаг мастера имеет:
- инструкцию "что сделать снаружи"
- форму ввода
- кнопку "Проверить"
- тестовые действия (подгрузка 3 диалогов)
- кнопку "Записать в Supabase" и проверку факта записи
- статус шага (зелёный/жёлтый/красный)

### 4.1 Supabase
В UI:
- поля: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- после сохранения показывать `***` вместо ключей
- кнопка "Проверить подключение"

Логика проверки:
- проверить формат URL
- сделать тестовый запрос (например, `select 1` или запрос к REST endpoint Supabase)
- убедиться, что ключи соответствуют проекту

Автогенерация SQL:
- на странице вывести SQL (1 блок) для создания таблиц в Supabase
- таблицы версии `schema_version`, чтобы можно было мигрировать

### 4.2 amoCRM
Проблема ngrok:
- в проде callback должен быть постоянным URL.

Решение:
- для каждого tenant формируем стабильный callback:
  - `https://synkro.kz/integrations/amocrm/callback/<tenant_slug>`
- эту строку пользователь (ты) копирует в amoCRM при создании интеграции

Данные для ввода в UI:
- `client_id`
- `client_secret`
- домен/аккаунт amoCRM (если нужен)
- long-lived token / refresh token (в зависимости от потока amoCRM)

Проверка:
- тестовая подгрузка 3 последних диалогов (или 3 последних сущности, которые однозначно доступны)
- показать их на экране (минимум: дата, менеджер, контакт, текст)

### 4.3 Radist
Ввод:
- API key (и базовый URL, если требуется)

Проверка:
- взять номера телефонов из результата amoCRM (тестовых 3 диалогов)
- подтянуть соответствующие разговоры/транскрипты из Radist (read-only)
- показать, что найдено, и что будет записано

Запись:
- записать в Supabase клиента и получить подтверждение вставки

### 4.4 AI (анализ)
Ввод:
- provider (пока 1: OpenAI или любой другой, который выберем)
- API key

Кнопка "Проверить":
- сделать запрос и загрузить список моделей (если провайдер это позволяет)
- дать выбрать модель из выпадающего списка

Промпт:
- большой textarea, сохраняется в центральной БД (привязано к tenant)

Тест-анализ:
- взять 3 диалога, сформировать пакет: PROMPT + диалоги
- отправить в AI, показать результат на экране
- сохранить результат в Supabase (опционально) и/или в центральной БД (для аудита)

### 4.5 Telegram
Ввод:
- токен бота
- chat_id группы

Проверка:
- отправить тестовое сообщение в группу

Тест-уведомление:
- отправить краткий отчет по 3 диалогам (из тест-анализа)

### 4.6 Автоматизация
Настройки:
- таймзона tenant
- "границы суток" (что считать сутками)
- расписание (ежедневно/еженедельно/вручную)

## 5) Пайплайн отчёта (основная логика)

### 5.1 Ручной запуск (кнопка "Принудительный отчет")
Шаги (строго по порядку, каждый шаг логирует статус):
1. Fetch amoCRM -> получить набор диалогов за период.
2. Write Supabase -> записать "сырые" диалоги.
3. Fetch Radist -> подтянуть транскрипты/звонки по номерам (read-only).
4. Write Supabase -> записать Radist данные.
5. Build prompt -> собрать пакет (prompts + нормализованные диалоги).
6. AI analyze -> получить анализ.
7. Persist result -> сохранить отчет и саммари.
8. Telegram notify -> отправить в группу.

Каждый шаг:
- идемпотентный (повторный запуск не ломает и не дублирует критично)
- с ретраями (Celery)
- с таймаутами и понятными ошибками

### 5.2 Индикаторы прогресса в UI
Схема "чекпоинтов":
- 6-8 кругов/статусов по шагам
- UI опрашивает сервер (polling) и обновляет статусы
- пользователю не показываем секреты и внутренности, только "в процессе/готово/ошибка"

## 6) Отчеты и follow-up вопросы

### 6.1 Список отчётов
Колонки:
- дата/период
- тип (дневной/недельный/месячный)
- статус
- комментарий пользователя
- кнопка "Открыть"

Комментарии:
- сохранять в центральной БД (или в Supabase клиента; решение выберем одно и будем последовательны)

Рекомендация:
- комментарии и follow-up хранить в центральной БД сервиса (так проще доступ/аудит).

### 6.2 Follow-up вопросы (до 2)
Поведение:
- после получения отчета можно задать вопрос в UI
- сервер отправляет: "предыдущий пакет + ответ + новый вопрос"
- лимит: максимум 2 follow-up
- затем UI показывает "связаться с админом"

## 7) Безопасность (MVP чеклист)

Обязательно:
- хранение секретов шифрованно (ключ шифрования только в env сервера)
- роли и ограничения на уровне view/API
- защита от брутфорса логина (rate limit / lockout)
- CSRF защита на формах
- `state` в OAuth (amoCRM) против подмены
- аудит-лог: кто менял ключи и запускал отчеты
- запрет на отображение ключей после сохранения

Желательно:
- 2FA для админов (после MVP)
- CSP заголовки
- отдельные права на "Настройки" (даже если пользователь вошел)

## 8) Деплой (контур)

### 8.1 Минимальная инфраструктура
- 1 VPS (для MVP достаточно)
- Docker Compose:
  - `web` (Django)
  - `worker` (Celery worker)
  - `beat` (Celery beat для расписаний)
  - `postgres`
  - `redis`
  - `nginx` (TLS termination, проксирование)

### 8.2 Домены
- `synkro.kz` -> nginx -> Django

### 8.3 Секреты и env
- `.env` на сервере (не в git)
- отдельный ключ `APP_SECRET_KEY` и `FIELD_ENCRYPTION_KEY`

## 9) План работ (по этапам) и критерии готовности

### Этап M0: Каркас проекта
Сделать:
- создать Django проект и базовые приложения
- подключить Postgres, Redis
- настроить миграции и базовую структуру

Готово, когда:
- приложение стартует локально
- есть подключение к Postgres
- есть health endpoint `/health`

### Этап M1: Auth + роли + админка
Сделать:
- страницы `/login`, `/logout`, защита `/dashboard`
- роли `super_admin`, `admin_lite`, `user`
- админка для управления пользователями/тенантами

Готово, когда:
- `super_admin` создает tenant и пользователя
- `user` не видит `Настройки`

### Этап M2: Dashboard UI (обзор/отчеты/настройки)
Сделать:
- общий layout и навигация
- неоморфизм: базовые компоненты (Card/Button/Input/Toggle)
- список отчетов (пока пустой)

Готово, когда:
- UI выглядит как единая система
- мобильная версия читаема

### Этап M3: Settings Wizard (Supabase -> amoCRM -> Radist)
Сделать:
- шаг Supabase: ввод, проверка, SQL для таблиц
- шаг amoCRM: callback, ввод данных, тестовые 3 диалога
- шаг Radist: ключ, тестовые диалоги по номерам

Готово, когда:
- тестовые данные записываются в Supabase клиента
- UI показывает зеленые статусы по шагам

### Этап M4: AI + Telegram + Принудительный отчет
Сделать:
- AI: проверка ключа, модели, промпт, тест-анализ
- Telegram: проверка, уведомление
- "Принудительный отчет": полный пайплайн с индикаторами

Готово, когда:
- отчет создается, сохраняется, появляется в списке
- Telegram получает уведомление

### Этап M5: Автоматизация + ретраи + аудит
Сделать:
- расписание (Celery beat)
- надежные ретраи/таймауты
- аудит-лог действий админов

Готово, когда:
- задача запускается по расписанию
- при сбое шагов есть понятные логи и повторы

## 10) Что считаем MVP
- вход/выход, роли, управление пользователями
- настройки интеграций с проверками
- ручной отчет "по кнопке"
- список отчетов + просмотр + комментарий
- Telegram уведомление

## 11) Зафиксированные решения (из ответов)
1. amoCRM "диалоги" не берем из amoCRM. Берем сделки/лиды и метаданные (lead/deal) + связи с контактами и телефонами.
   Источник: `/api/v4/leads` (обновленные в окне), `/api/v4/leads/{id}/links`, `/api/v4/contacts`.
2. Radist — источник диалогов. "Диалог" = чат (messaging chat) + сообщения.
   Методы: `/companies/{company_id}/messaging/chats/with_contacts/` и `/companies/{company_id}/messaging/messages/?chat_id=...`.
3. AI провайдер — Gemini (ключ будет предоставлен позже).
4. Текст отчета хранится в Supabase клиента (центральная БД хранит саммари и статус).
